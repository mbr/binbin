#!/usr/bin/python3

# argparse, because we don't want external dependenceis

import click
import subprocess
import sys
import time

QUIET = False


def exit_err(msg, exitcode=1):
    click.secho(msg, file=sys.stderr, fg='red')
    sys.exit(exitcode)


def info(msg):
    if not QUIET:
        click.echo(click.style('#', fg='cyan', bold=True) + ' ' + msg)


@click.command()
@click.argument('cmd', nargs=-1)
@click.option('-f',
              '--file',
              'files',
              multiple=True,
              default=['.'],
              help='file or dir to watch (default: .)')
@click.option('-q',
              '--quiet',
              is_flag=True,
              default=False,
              help='Suppress all output not generated by the command itself')
@click.option('-c',
              '--clear',
              is_flag=True,
              default=False,
              help='Clear screen before executing command')
def cli(files, cmd, quiet, clear):
    global QUIET
    QUIET = quiet

    if not cmd:
        exit_err('missing command')
        sys.exit(1)

    inotify_args = [
        'inotifywait',
        '--recursive',
        '--quiet',
        '--event',
        'modify,create,delete,move',
    ]

    inotify_args.extend(files)

    while True:
        if clear:
            click.clear()
            sys.stdout.flush()

        # run command
        info('running ' + click.style('{}'.format(' '.join(cmd)), fg='yellow'))

        start = time.time()
        p = subprocess.Popen(cmd)
        p.wait()
        total = time.time() - start

        # watch for changes
        total_s = click.style('{:.4}s'.format(total),
                              fg='green' if p.returncode == 0 else 'red')
        status_s = click.style(
            'ok',
            fg='green') if p.returncode == 0 else click.style(
                'err({})'.format(p.returncode),
                fg='red')

        info(status_s + ', took {} seconds. waiting for changes...'.format(
            total_s))

        p = subprocess.Popen(
            inotify_args,
            stderr=None if not quiet else open('/dev/null', 'wb'),
            stdout=None if not quiet else open('/dev/null', 'wb'))
        p.wait()

        if p.returncode != 0:
            exit_err('inotifywait failed: {}/{}', p.stdout, p.stderr)


if __name__ == '__main__':
    cli()
