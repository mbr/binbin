#!/usr/bin/python3

# argparse, because we don't want external dependenceis

import click
import subprocess
import sys


def exit_err(msg, exitcode=1):
    click.secho(msg, file=sys.stderr, fg='red')
    sys.exit(exitcode)


@click.command()
@click.argument('cmd', nargs=-1)
@click.option('-f',
              '--file',
              'files',
              multiple=True,
              default=['.'],
              help='file or dir to watch (default: .)')
def cli(files, cmd):
    if not cmd:
        exit_err('missing command')
        sys.exit(1)

    files = list(files)

    while True:
        # run command
        p = subprocess.Popen(cmd)
        p.wait()

        # watch for changes
        click.echo('Waiting for changes...')
        p = subprocess.Popen([
            'inotifywait',
            '--quiet',
            '--recursive',
            '--event',
            'modify,create,delete,move',
        ] + files)
        p.wait()
        if p.returncode != 0:
            exit_err('inotifywait failed: {}/{}', p.stdout, p.stderr)


if __name__ == '__main__':
    cli()
